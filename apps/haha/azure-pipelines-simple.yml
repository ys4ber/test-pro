# Azure DevOps Pipeline for WordPress App: haha
# Simplified Multi-Stage Deployment using Ansible (without environments)

name: haha-Deploy-Simple-v2

trigger:
  branches:
    include:
      - youssef/init

  paths:
    include:
      - apps/haha/**/*

pr:
  branches:
    include:
      - youssef/init
      
  paths:
    include:
      - apps/haha/**/*

variables:
  APP_NAME: 'haha'
  DEPLOY_USER: 'liadwordpress'
  SERVER_IP: '192.99.35.79'
  WP_URL_TEST: 'http://192.99.35.79:4000'
  WP_URL_PREPROD: 'http://192.99.35.79:4100'
  WP_URL_PROD: 'http://192.99.35.79:4200'
  PMA_URL_TEST: 'http://192.99.35.79:4001'
  PMA_URL_PREPROD: 'http://192.99.35.79:4101'
  PMA_URL_PROD: 'http://192.99.35.79:4201'

stages:
  # =============================================================================
  # TEST STAGE
  # =============================================================================
  - stage: Test
    displayName: "ğŸ§ª Test Environment"
    variables:
      DEPLOY_ENVIRONMENT: 'ysaber-env'
      ANSIBLE_INVENTORY: 'ansible/inventories/test/hosts'
    jobs:
      - job: DeployTest
        displayName: "ğŸš€ Deploy to Test"
        steps:
          - checkout: self
            displayName: "ğŸ“¥ Checkout Source Code"

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
            displayName: "ğŸ Setup Python"

          - script: |
              sudo apt-get update -qq
              sudo apt-get install -y ansible sshpass rsync
              ansible --version
            displayName: "ğŸ“¦ Install Ansible Dependencies"

          - script: |
              echo "ğŸ“¦ Installing Ansible Collections..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              # Install required collections
              ansible-galaxy collection install community.docker
              ansible-galaxy collection install ansible.posix
              
              # Install from requirements if it exists
              if [ -f "$APP_PATH/ansible/requirements.yml" ]; then
                ansible-galaxy collection install -r "$APP_PATH/ansible/requirements.yml"
              fi
              
              echo "âœ… Ansible collections installed"
            displayName: "ğŸ“¦ Install Ansible Collections"

          - script: |
              echo "ğŸ” Validating Ansible configuration..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              if [ ! -d "$APP_PATH" ]; then
                echo "âŒ App directory not found: $APP_PATH"
                exit 1
              fi
              
              if [ ! -f "$APP_PATH/ansible/deploy-fast.yml" ]; then
                echo "âŒ Ansible playbook not found: $APP_PATH/ansible/deploy-fast.yml"
                exit 1
              fi
              
              if [ ! -f "$APP_PATH/$(ANSIBLE_INVENTORY)" ]; then
                echo "âŒ Ansible inventory not found: $APP_PATH/$(ANSIBLE_INVENTORY)"
                exit 1
              fi
              
              echo "âœ… Ansible configuration validated"
              echo "ğŸ“‹ App structure:"
              ls -la "$APP_PATH"
            displayName: "ğŸ” Validate Ansible Configuration"

          - script: |
              echo "ğŸ”§ Deploying with Ansible to Test Environment (Fast Mode)..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) wp_url=$(WP_URL_TEST) pma_url=$(PMA_URL_TEST) ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" \
                -v
            displayName: "ğŸ”§ Deploy with Ansible to Test (Fast)"

          - script: |
              echo "ğŸ¥ Running Test Environment Health Checks..."
              
              # Function to test endpoint
              test_endpoint() {
                local url=$1
                local name=$2
                local max_attempts=5
                local attempt=1
                
                while [ $attempt -le $max_attempts ]; do
                  echo "ğŸ” Testing $name (attempt $attempt/$max_attempts)..."
                  if curl -f -s -m 10 "$url" > /dev/null 2>&1; then
                    echo "âœ… $name is healthy"
                    return 0
                  fi
                  sleep 10
                  ((attempt++))
                done
                
                echo "âŒ $name failed health check"
                return 1
              }
              
              # Wait for services
              sleep 30
              
              # Test endpoints
              test_endpoint "$(WP_URL_TEST)" "WordPress Test Frontend"
              test_endpoint "$(PMA_URL_TEST)" "phpMyAdmin Test"
              
              echo "âœ… Test environment health checks completed"
            displayName: "ğŸ” Test Environment Health Check"

  # =============================================================================
  # PREPROD STAGE
  # =============================================================================
  - stage: PreProd
    displayName: "ğŸš§ PreProd Environment"
    dependsOn: Test
    condition: succeeded()
    variables:
      DEPLOY_ENVIRONMENT: 'ysaber-env'
      ANSIBLE_INVENTORY: 'ansible/inventories/preprod/hosts'
    jobs:
      - job: DeployPreProd
        displayName: "ğŸ“† Deploy to PreProd"
        steps:
          - checkout: self
            displayName: "ğŸ“¥ Checkout Source Code"

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
            displayName: "ğŸ Setup Python"

          - script: |
              sudo apt-get update -qq
              sudo apt-get install -y ansible sshpass rsync
            displayName: "ğŸ“¦ Install Ansible Dependencies"

          - script: |
              echo "ï¿½ Installing Ansible Collections..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              # Install required collections
              ansible-galaxy collection install community.docker
              ansible-galaxy collection install ansible.posix
              
              # Install from requirements if it exists
              if [ -f "$APP_PATH/ansible/requirements.yml" ]; then
                ansible-galaxy collection install -r "$APP_PATH/ansible/requirements.yml"
              fi
              
              echo "âœ… Ansible collections installed"
            displayName: "ğŸ“¦ Install Ansible Collections"

          - script: |
              echo "ï¿½ğŸ’¾ Creating PreProd backup..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              # Create backup playbook run
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) backup_only=true ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" || echo "Backup completed or not needed"
            displayName: "ğŸ’¾ Backup PreProd Environment"

          - script: |
              echo "ğŸ”§ Deploying with Ansible to PreProd Environment (Fast Mode)..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) wp_url=$(WP_URL_PREPROD) pma_url=$(PMA_URL_PREPROD) ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" \
                -v
            displayName: "ğŸ”§ Deploy with Ansible to PreProd (Fast)"

          - script: |
              echo "ğŸ¥ Running PreProd Environment Health Checks..."
              
              # Function to test endpoint
              test_endpoint() {
                local url=$1
                local name=$2
                local max_attempts=3
                local attempt=1
                
                while [ $attempt -le $max_attempts ]; do
                  echo "ğŸ” Testing $name (attempt $attempt/$max_attempts)..."
                  if curl -f -s -m 15 "$url" > /dev/null 2>&1; then
                    echo "âœ… $name is healthy"
                    return 0
                  fi
                  sleep 15
                  ((attempt++))
                done
                
                echo "âŒ $name failed health check"
                return 1
              }
              
              # Wait for services
              sleep 45
              
              # Test endpoints
              test_endpoint "$(WP_URL_PREPROD)" "WordPress PreProd Frontend"
              test_endpoint "$(WP_URL_PREPROD)/wp-admin" "WordPress PreProd Admin"
              test_endpoint "$(PMA_URL_PREPROD)" "phpMyAdmin PreProd"
              
              echo "âœ… PreProd environment health checks completed"
            displayName: "ğŸ” PreProd Environment Health Check"

  # =============================================================================
  # PRODUCTION STAGE
  # =============================================================================
  - stage: Production
    displayName: "ğŸ­ Production Environment"
    dependsOn: PreProd
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    variables:
      DEPLOY_ENVIRONMENT: 'ysaber-env'
      ANSIBLE_INVENTORY: 'ansible/inventories/prod/hosts'
    jobs:
      - job: DeployProduction
        displayName: "ğŸ¯ Deploy to Production"
        steps:
          - checkout: self
            displayName: "ğŸ“¥ Checkout Source Code"

          - task: UsePythonVersion@0
            inputs:
              versionSpec: '3.x'
            displayName: "ğŸ Setup Python"

          - script: |
              sudo apt-get update -qq
              sudo apt-get install -y ansible sshpass rsync
            displayName: "ğŸ“¦ Install Ansible Dependencies"

          - script: |
              echo "ï¿½ Installing Ansible Collections..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              # Install required collections
              ansible-galaxy collection install community.docker
              ansible-galaxy collection install ansible.posix
              
              # Install from requirements if it exists
              if [ -f "$APP_PATH/ansible/requirements.yml" ]; then
                ansible-galaxy collection install -r "$APP_PATH/ansible/requirements.yml"
              fi
              
              echo "âœ… Ansible collections installed"
            displayName: "ğŸ“¦ Install Ansible Collections"

          - script: |
              echo "ï¿½ğŸ’¾ Creating Production backup..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              # Create comprehensive backup
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) backup_only=true full_backup=true ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" || echo "Backup completed or not needed"
            displayName: "ğŸ’¾ Backup Production Environment"

          - script: |
              echo "â¸ï¸ Enabling maintenance mode..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) maintenance_mode=true ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" || echo "Maintenance mode enabled"
            displayName: "â¸ï¸ Enable Maintenance Mode"

          - script: |
              echo "ğŸ”§ Deploying with Ansible to Production Environment (Fast Mode)..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) wp_url=$(WP_URL_PROD) pma_url=$(PMA_URL_PROD) ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" \
                -v
            displayName: "ğŸ”§ Deploy with Ansible to Production (Fast)"

          - script: |
              echo "â–¶ï¸ Disabling maintenance mode..."
              APP_PATH="$(Build.SourcesDirectory)/apps/$(APP_NAME)"
              
              cd "$APP_PATH"
              ansible-playbook ansible/deploy-fast.yml \
                -i $(ANSIBLE_INVENTORY) \
                --extra-vars "app_name=$(APP_NAME) environment=$(DEPLOY_ENVIRONMENT) maintenance_mode=false ssh_password=$(SSH_PASSWORD)" \
                --ssh-extra-args="-o StrictHostKeyChecking=no -o Port=2220" || echo "Maintenance mode disabled"
            displayName: "â–¶ï¸ Disable Maintenance Mode"

          - script: |
              echo "ğŸ¥ Running Production Health Checks..."
              
              # Function to test endpoint with retries
              test_endpoint() {
                local url=$1
                local name=$2
                local max_attempts=5
                local attempt=1
                
                while [ $attempt -le $max_attempts ]; do
                  echo "ğŸ” Testing $name (attempt $attempt/$max_attempts)..."
                  if curl -f -s -m 15 "$url" > /dev/null 2>&1; then
                    echo "âœ… $name is healthy"
                    return 0
                  fi
                  sleep 15
                  ((attempt++))
                done
                
                echo "âŒ $name failed health check"
                return 1
              }
              
              # Wait for services to fully start
              sleep 60
              
              # Test all endpoints
              test_endpoint "$(WP_URL_PROD)" "WordPress Production Frontend"
              test_endpoint "$(WP_URL_PROD)/wp-admin" "WordPress Production Admin"
              test_endpoint "$(PMA_URL_PROD)" "phpMyAdmin Production"
              
              echo "âœ… Production environment health checks completed"
            displayName: "ğŸ” Production Health Check"

          - script: |
              echo ""
              echo "ğŸ‰ PRODUCTION DEPLOYMENT SUCCESSFUL"
              echo "=================================================="
              echo "ğŸ“± Application: $(APP_NAME)"
              echo "ğŸŒ WordPress: $(WP_URL_PROD)"
              echo "ğŸ” Admin Panel: $(WP_URL_PROD)/wp-admin"
              echo "ğŸ—„ï¸ phpMyAdmin: $(PMA_URL_PROD)"
              echo "ğŸ—ï¸ Build: $(Build.BuildNumber)"
              echo "ğŸ“… Deployed: $(date)"
              echo ""
              echo "ğŸ”§ SSH Access:"
              echo "  ssh $(DEPLOY_USER)@$(SERVER_IP)"
              echo ""
              echo "ğŸ“‹ Management Commands:"
              echo "  cd /home/$(DEPLOY_USER)/$(APP_NAME)-prod"
              echo "  docker compose ps          # Check status"
              echo "  docker compose logs        # View logs"
              echo "  docker compose restart     # Restart services"
              echo ""
              echo "ğŸ¯ Environment URLs:"
              echo "  Test: $(WP_URL_TEST)"
              echo "  PreProd: $(WP_URL_PREPROD)"
              echo "  Production: $(WP_URL_PROD)"
              echo ""
            displayName: "ğŸ‰ Production Deployment Summary"
